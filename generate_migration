#!/bin/bash
set -e
SCRIPTS_PATH="$(dirname $0)"
MIGRATES_PATH="${SCRIPTS_PATH}/migrates"

# Create migrates directory if not exists.
mkdir -p "${MIGRATES_PATH}"

# Get migration name
INPUT_MIGRATION_NAME="$@"

if [[ "${INPUT_MIGRATION_NAME}" == "" ]]; then
    echo -n "Migration name: "
    read INPUT_MIGRATION_NAME
    echo ""
fi

MIGRATION_NAME=`echo ${INPUT_MIGRATION_NAME// /_} | tr '[:upper:]' '[:lower:]'`
if [[ "${MIGRATION_NAME}" == "" ]]; then
    echo "[E] Must type migration name!"
    exit 1
fi

# Check containing non-alphanumeric letter except underscore.
if [[ ! "${MIGRATION_NAME}" =~ ^[a-zA-Z0-9_]+$ ]] || [[ "${MIGRATION_NAME}" =~ ^[0-9]+$ ]] ; then
    echo "[E] Migration name must not have non-alphanumeric letter except underscore!"
    exit 1
fi 

# Define migration timestamp
NEXT_MIGRATION_NUMBER="$(date +%Y%m%d%H%M%S)"
MIGRATION_FILE_PATH="${MIGRATES_PATH}/${NEXT_MIGRATION_NUMBER}_${MIGRATION_NAME}.sql"

# Create migration
if [[ -e "${MIGRATION_FILE_PATH}" ]]; then
    echo "[E] Migration file already exists!"
    exit 1
fi
touch ${MIGRATION_FILE_PATH}
echo "/* This migration file was generated by ${0} at ${NEXT_MIGRATION_NUMBER} */" > ${MIGRATION_FILE_PATH}
echo "Migration generated!"
echo " - ${MIGRATION_FILE_PATH}"
echo ""